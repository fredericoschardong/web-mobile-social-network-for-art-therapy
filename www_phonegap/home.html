<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        <link rel="stylesheet" type="text/css" href="css/index.css" />
        <link rel="stylesheet" type="text/css" href="css/jquery.css" />
        
        <script type="text/javascript" src="cordova-2.5.0.js"></script>
    	<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
    	<script type="text/javascript" src="js/jquery.mobile-1.2.0.min.js"></script>
    	
    	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&amp;language=en"></script>
    	<script type="text/javascript" src="js/gmap3.js"></script>
    	
    	<script type="text/javascript" src="js/jquery-dateFormat.js"></script>
    	<script type="text/javascript" src="js/jquery-blockui.js"></script>
    	
    	<script type="text/javascript" src="js/index.js"></script>
    	
        <title>Cool App</title>
    </head>
    <body>
        <div data-role="page" id="page1">
            <div data-role="header" data-theme="a" data-position="fixed">
		        <h3>Cool App</h3>
		        <a href="#nav-panel" data-icon="bars" data-iconpos="notext">Menu</a>
    		</div><!-- /header -->
            <div data-role="content" id="content">
            	<div id='map'>
            	</div>
            </div>
            
            <div data-role="panel" data-position-fixed="true" data-theme="a" id="nav-panel">
		        <ul data-role="listview" data-theme="a" class="nav-search">
		            <li><a onClick="window.location.href = 'home.html';">Home</a></li>
		            <li><a onClick="window.location.href = 'add_photo.html';">Add photo</a></li>
		            <li><a href="#">My photos</a></li>
		            <li><a href="#">Profile</a></li>
		            <li><a href="#">My group</a></li>
		            <li><a href="#">Account</a></li>
		            <li><a onClick="window.location.href = 'login.html';">Logout</a></li>
		        </ul>
	    	</div>
        </div>
        <script>
        	function onDeviceReady(){
        		console.log('jquery bbbb');
        		
				$.ajax({
					url: "http://" + window.localStorage.getItem("server") +"/index.php",
					type: "POST",
					data: { 
							mobile: 'true'
						  }
					}).always(function(msg){
						var obj = jQuery.parseJSON(msg);
						
						if(!msg || !obj){
							alert("Error obtaining data");
							navigator.app.exitApp();						
						}
						
						$('#content').html('');
						
						$.each(obj, function(i, v){
							var a = " \
							<div class='feed'> \
								<div class='thumb'> \
									<a class='ui-link'> \
										<img src='http://" + window.localStorage.getItem("server") +"/files/users/photo/" + v['Images']['users_id'] + "/thumb_" + v['Users']['photo'] + "'> \
									</a> \
								</div> \
								<div class='title'> \
									<a class='ui-link' href='profile.html?id=" + v['Users']['id'] + "'> \
										" + v['Users']['name'] + " - " + $.format.date(v['Images']['date_add'], "dd/MM/yyyy hh:mm:ss") + " \
									</a> \
								</div> \
								<div class='image'> \
									<a class='ui-link'> \
										<img src='http://" + window.localStorage.getItem("server") +"/files/images/photo/" + v['Images']['id'] + "/xvga_" + v['Images']['photo'] + "'> \
									</a> \
								</div> \
								<div class='image pre_comment'> \
									<p> \
										" + v['Images']['description'] + " \
									</p> \
								</div>";
								
							if(v['Images']['lat'] != 0 && v['Images']['lng'] != 0){
								a += " \
								<a data-role='button' class='map'> \
				                    Show map \
				                </a> \
  								<div style='display:none;' class='map " + v['Images']['lat'] + " " + v['Images']['lng'] + " " + v['Images']['acc'] + "'> \
								</div>";
							}
							
							a += " \
							<p> \
								Comments: \
							</p>";
							
							$.each(v['Comments'], function(c, b){
								a += " \
								<p> \
									<a> \
										" + b['Users']['name'] + " \
									</a> \
									in " + $.format.date(b['date'], "dd/MM/yyyy hh:mm:ss") + " said: \
								</p> \
								<p> " + b['comment'] + " </p>";
							});
							
							a += "</div>";
							
							$('#content').append(a);
						});
						
						$('a.map').buttonMarkup();
						
						$('a.map').click(function(){
							if(!$(this).next().is(":visible")){
								$.blockUI({ message: '<img src="css/images/ajax-loader.gif" />'}); 
								
								$(this).next().show('slow', function(){
									if($(this).html().trim() == ""){
										var lat = $(this).attr('class').split(' ')[1];
										var lng = $(this).attr('class').split(' ')[2];
										
										$(this).width($(this).prev().width()).height($(this).prev().width()).gmap3({
											map:{
												options:{
													center:[lat, lng],
													zoom:14
												}
											},
											circle:{
											    options:{
											      center:[lat, lng],
											      radius: parseInt($(this).attr('class').split(' ')[3]),
											      fillColor : "#008BB2",
											      strokeColor : "#005BB7"
											    }
											},
											marker:{
											    latLng:[lat, lng]
											}
										});
									}
								});
								
								window.setTimeout(function() {
									$.unblockUI();
								}, 3000);
							}
							else{
								$.blockUI({ message: '<img src="css/images/ajax-loader.gif" />'}); 
								
								$(this).next().hide('slow', function(){
									$.unblockUI();
								});
							}
						});
					});
    			}
        	
        </script>
    </body>
</html>
